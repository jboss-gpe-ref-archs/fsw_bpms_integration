:data-uri:
:toc2:
:rpms: link:https://github.com/jboss-gpe-ose/jboss_bpm_soa_rpmbuild[RPMs]
:bpmcart: link:https://github.com/jboss-gpe-ose/openshift-origin-cartridge-bpms-full[Red Hat GPE's BPM Suite 6 cartridge]
:fswcart: link:https://github.com/jboss-gpe-ose/openshift-origin-cartridge-fsw-full[Red Hat GPE's FSW cartridge]
:bpmproduct: link:https://access.redhat.com/site/documentation/en-US/Red_Hat_JBoss_BPM_Suite/[Red Hat's BPM Suite 6 product]
:fswproduct: link:https://access.redhat.com/site/documentation/en-US/Red_Hat_JBoss_Fuse_Service_Works/[Red Hat's FSW product]

image::images/rhheader.png[width=900]

:numbered!:
[abstract]
== Fuse Service Works / BPM Suite 6 Integration

== Overview
Many enterprise software applications leverage a Business Process Management (BPM) tool.
The BPM solution maintains and manages the state of long-running business processes.
In an enterprise software application that leverages a BPM tool, it is highly recommended that business services continue to be implemented independent of the BPM tool and in adherence to SOA.
In particular, these business services should be course-grained, re-usable, contract-based, stateless and be exposed by standards based protocols.
During the lifecycle of a business process instance, nodes of that process instance should invoke the remote services that encapsulate the business logic.
Correspondingly, these business services should drive the lifecylce of process instances by invoking APIs provided by the BPM tool.

This _xPaaS_ reference architecture demonstrates a _process tier_ and _service tier_ interacting with each-other.
Specifically, a SwitchYard SCA application drives the life-cycle of a BPMN2 process instance whose state is managed remotely by BPM Suite 6.
To do so, the SwitchYard SCA application invokes the REST API of the BPM Suite 6 execution server using the stock RESTEasy composite binding implementation.
The _process tier_ is implemented in a Red Hat Openshift _gear_ provisioned with Red Hat JBoss BPM Suite 6.
The _service tier_ is implemented in a Red Hat Openshift _gear_ provisioned with Red Hat JBoss Fuse Service Works 6.

image::images/dep_arch.png[]

== Pre-Requisites
The remainder of this documentation provides instructions for installation, configuration and execution of this reference architecture.
The following is a list of pre-requisites:

. {osetools}
. Openshift Enterprise 2.* environment that has been installed with {rpms} needed to support {cart}.  Contact the Red Hat GPE team for more details.
. medium-sized Openshift Enterprise gear provisioned with {bpmcart} and mysql-5.
. medium-sized Openshift Enterprise gear provisioned with {fswcart} and mysql-5.
. ssh client
. maven 3.0.5 (or greater)
. git client
. familiarity with {bpmproduct}
. familiarity with {fswproduct}
. proficiency with basic *nix command line
. proficiency with vi

As is evidenced by these pre-requisites, the assumed BPM Suite 6 runtime environment for this reference architecture documentation is an Openshift Enterprise gear.
However, BPM Suite 6 and Fuse Service Works can be installed in non-PaaS local environments.
Thus it could be possible to execute this reference architecture in a non-PaaS local environment as well.

== Configuration and Execution

=== Clone this reference architecture in local environment
This reference architecture will be cloned both in your local computer as well as in your remote BPM Suite 6 Openshift environment.
To clone this reference architecture in your local environment, execute the following:

-----
git clone https://github.com/jboss-gpe-ref-archs/fsw_bpms_integration.git
-----

Doing so will create a directory in your local computer called:  _fsw_bpms_integration_.
For the purposes of the remainder of this reference architecture, this directory will be referred to as _$REF_ARCH_HOME_.


=== Domain class installation
In $REF_ARCH_HOME, there is a directory called `domain`.
This directory contains a maven project for building and packaging the jar files that will contain the domain classes for this reference architecture.
If you examine the domain classes, you will find that they are configured to enable serialization via Java Architecture for XML Binding (JAXB).

The following steps are directions for building the jar file and installing the jar as a static module in your FSW and BPM Suite 6 servers running in OpenShift.
The `business-central.war` application in BPM Suite 6 will also be configured to have a dependency on the static module, making the domain class available to use in your business processes.

From your local cloned copy of this reference architecture execute the following:

. create the jar for the domain classes
.. `cd $REF_ARCH_HOME`
.. `mvn clean install`
. copy the directories and files required to create a static module on both FSW and BPM Suite 6 remote servers
.. `scp -r domain/conf/com <your_openshift_url>:~/app-root/data/appModules/`
.. `scp domain/target/domain-1.0.jar    <ssh_url_to_your_openshift_environment>:~/app-root/data/appModules/com/redhat/gpe/refarch/fsw_bpms_integration/domain/main/`
. Add an explicit dependency for business-central.war on the static module for the domain module
.. `ssh <your_openshift_url>`
.. Open the following file using vi:  `~/bpms/standalone/deployments/business-central.war/WEB-INF/jboss-deployment-structure.xml`
.. Add the following to the list of dependencies:

-----
<module name="com.redhat.gpe.refarch.fsw_bpms_integration.domain" export="true"/>
-----

[start=4]
. Save the changes to the file
. Restart your OpenShift BPM Suite 6 instance

=== Clone this reference architecture in BPM Suite 6
This reference architecture uses a simple business process that includes a human task node followed by a RESTful _Service Task_ .

image::images/processTier_bpmn.png[]

Use the following steps to clone this reference architecture in BPM Suite 6:

. Create an *Organization and clone this project's git repository in your BPM Suite 6 server
.. Select `Authoring` -> `Administration`
.. Select `Organizational Units` -> `Manage Organizational Units`
.. Under `Organizational Unit Manager`, select the `Add` button
.. Enter a name of _gpe_ and an owner of _jboss_. Click `Ok`
. Clone this fsw_bpms_integration repository in BPM Suite 6
.. Select `Repositories` -> `Clone Repository` .  Populate the _Clone Repository_ box as follows and then click _Clone_ :

image::images/clone_repo.png[]

Enter _fswbpmsintegration_ as the value of the _repository name_.  The _Git URL_ is the URL to this git project in github:

-----
https://github.com/jboss-gpe-ref-archs/fsw_bpms_integration.git
-----

Once successfully cloned, BPM Suite 6 will pop-up a new dialog box with the message:  _The repository is cloned successfully_

=== Modify parameters of RESTful Service Task

* In the _policyQuoteProcessMap_ process definition, click the last node entitled: _POST Review Results_.
* In the _Properties_ section of the BPM Designer, click the _Assignments_ property such that the _Editor for Data Assignments_ pop-up appears:

image::images/mod_service_task.png[]

* Fill in the values for each _Assignment_ as follows:

. `Url`   :   http://<your_fsw_server_address>/policyQuoteMgmt/policy
. `ConnectTimeout`  :   5000
. `Password`  :   jboss
. `Username`  :   brms
. `Method`    :   POST
. `ReadTimeout`    :   5000


* Save the changes to the process definition.
* Navigate to the _Project Editor_ and click the button at the top-right to `Build & Deploy`
** A light-green pop-up should appear indicating: _Build Successful_

The _org.acme.insurance:policyquote:1.0_ KIE project is now deployed as a maven artifact in your remote BPM Suite 6 environment and is registered with the embedded _Execution Server_.
The lifecycle of the project's business processes can now be remotely driven through the REST API of the _Execution Server_.

=== Define System Properties in FSW Openshift environment

image::images/add_sys_props.png[]

image::images/sys_props_added.png[]

. bpms.exec.server.hostname :   http://<your_bpms_server_address>
. bpms.exec.server.port :   80

=== Deploy _Service Tier_ artifacts to FSW Openshift environment

=== Exception Handling
* https://bugzilla.redhat.com/show_bug.cgi?id=1091061

=== To-Do
* specify role used to query for potential tasks
* demonstrate invocation of the following BPM Suite 6 task operation:  claimnextavailable
* error handling when substitution properties in URL of REST invocation are not valid
** currently rolls back outside of scope of ProcessMgmtBean
** causes multiple invocations of startProcess call)
